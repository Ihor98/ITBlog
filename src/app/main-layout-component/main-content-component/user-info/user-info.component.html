<div id="welcome">Hello, {{currentUser.firstname + ' ' + currentUser.lastname}} !</div>
<h2>Search form</h2>
<form [formGroup]="searchForm">
  <div class="form-row">
    <div class="form-group col">
      <input
        type="text"
        class="form-control"
        placeholder="First Name"
        formControlName="firstname"
      />
    </div>
    <div class="form-group col">
      <input
        type="text"
        class="form-control"
        placeholder="Last Name"
        formControlName="lastname"
      />
    </div>
  </div>
  <div class="form-row">
    <div class="form-group col">
      <input
        type="text"
        class="form-control"
        placeholder="Username"
        formControlName="username"
      />
    </div>
    <div class="form-group col">
      <input
        type="text"
        class="form-control"
        placeholder="Email"
        formControlName="mail"
      />
    </div>
    <div class="form-group col">
      <input
        type="text"
        class="form-control"
        placeholder="Phone"
        formControlName="phone"
      />
    </div>
  </div>
</form>
<button class="btn btn-outline-primary" (click)="clear()">Clear</button>
<button class="btn btn-primary ml-5" (click)="getUsers()">Find</button>
<table class="table table-hover mt-5" *ngIf="toggle">
  <thead>
    <tr>
      <th>No.</th>
      <th>First Name</th>
      <th>Last Name</th>
      <th>Username</th>
      <th>Phone</th>
      <th colspan="3">Action</th>
    </tr>
  </thead>
  <tbody>
    <ng-container *ngFor="let user of users; index as i">
      <tr *ngIf="user.showUserInfo">
        <td>{{ i + 1 }}</td>
        <td>{{ user.firstname }}</td>
        <td>{{ user.lastname }}</td>
        <td>{{ user.username }}</td>
        <td>{{ user.phone }}</td>
        <td colspan="3">
          <button
            class="btn btn-outline-primary mr-3"
            (click)="user.showUserInfo = !user.showUserInfo"
          >
            Update
          </button>
          <button
            class="btn btn-success mr-3"
            data-toggle="collapse"
            [attr.data-target]="'#' + i"
            aria-expanded="true"
            [attr.aria-controls]="i"
            (click)="user.adressToggle = !user.adressToggle; user.showAddAdress=false"
          >
            Adress info
          </button>
          <button class="btn btn-danger" (click)="deleteUser(user.id)">
            Delete
          </button>
        </td>
      </tr>
      <tr *ngIf="!user.showUserInfo" [id]="i">
        <td colspan="12">
          <form [formGroup]="updatedUsersForm">
            <table class="table">
              <ng-container formArrayName="updatedUserInfoArray">
                <tr [formGroupName]="i" [id]="i">
                  <td>{{ i + 1 }}</td>
                  <td>
                    <input
                      type="text"
                      class="form-control"
                      formControlName="firstname"
                    />
                  </td>
                  <td>
                    <input
                      type="text"
                      class="form-control"
                      formControlName="lastname"
                    />
                  </td>
                  <td>
                    <input
                      type="text"
                      class="form-control"
                      formControlName="username"
                    />
                  </td>
                  <td>
                    <input
                      type="text"
                      class="form-control"
                      formControlName="phone"
                    />
                  </td>
                  <td>
                    <button
                      class="btn btn-outline-primary mr-1"
                      (click)="
                        updateUserData(user, user.id,
                          updatedUsersForm.get('updatedUserInfoArray')
                            ?.controls[i].value
                        )
                      "
                    >
                      Save
                    </button>
                  </td>
                </tr>
              </ng-container>
            </table>
          </form>
        </td>
      </tr>
      <tr *ngIf="user.adressToggle">
        <td colspan="12">
          <div class="collapse show" [id]="i">
            <table class="table">
              <thead>
                <tr>
                  <th>Adress type</th>
                  <th>Country</th>
                  <th>City</th>
                  <th>Postal code</th>
                  <th>Adress</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody>
                <ng-container
                  *ngFor="let adress of user.formAdress; index as j"
                >
                  <tr *ngIf="!adress.showAdressInfo">
                    <td>{{ adress.adressType }}</td>
                    <td>{{ adress.country }}</td>
                    <td>{{ adress.city }}</td>
                    <td>{{ adress.postalCode }}</td>
                    <td>{{ adress.adress }}</td>
                    <td>
                      <button
                        class="btn btn-outline-primary mr-1"
                        (click)="adress.showAdressInfo = !adress.showAdressInfo"
                      >
                        Update
                      </button>
                      <button
                        class="btn btn-danger mr-1"
                        (click)="deleteAdress( i,  j, user.id)"
                      >
                        Delete
                      </button>
                      <button
                        class="btn btn-primary"
                        (click)="user.showAddAdress = !user.showAddAdress"
                      >
                        Add
                      </button>
                    </td>
                  </tr>
                  <tr *ngIf="adress.showAdressInfo">
                    <td colspan="12">
                      <form [formGroup]="updatedUsersForm">
                        <table class="table">
                          <ng-container formArrayName="updatedUserInfoArray">
                            <tr [formGroupName]="i">
                              <ng-container formArrayName="formAdress">
                                <ng-container [formGroupName]="j">
                                  <td>
                                    <select
                                      class="custom-select form-control"
                                      formControlName="adressType"
                                    >
                                      <option value="Billing Address">
                                        Billing Address
                                      </option>
                                      <option value="Shipment Address">
                                        Shipment Address
                                      </option>
                                      <option value="Home Address">
                                        Home Address
                                      </option>
                                    </select>
                                  </td>
                                  <td>
                                    <input
                                      type="text"
                                      class="form-control"
                                      formControlName="country"
                                    />
                                  </td>
                                  <td>
                                    <input
                                      type="text"
                                      class="form-control"
                                      formControlName="city"
                                    />
                                  </td>
                                  <td>
                                    <input
                                      type="text"
                                      class="form-control"
                                      formControlName="postalCode"
                                    />
                                  </td>
                                  <td>
                                    <input
                                      type="text"
                                      class="form-control"
                                      formControlName="adress"
                                    />
                                  </td>
                                  <td>
                                    <button
                                      class="btn btn-outline-primary mr-1"
                                      (click)="
                                        updateUserData(user, user.id,
                                          updatedUsersForm.get(
                                            'updatedUserInfoArray'
                                          )?.controls[i].value
                                        )
                                      "
                                    >
                                      Save
                                    </button>
                                  </td>
                                </ng-container>
                              </ng-container>
                            </tr>
                          </ng-container>
                        </table>
                      </form>
                    </td>
                  </tr>
                </ng-container>
                <tr *ngIf="user.showAddAdress" [formGroup]="newAdressForm">
                  <td width="15%">
                    <select
                      class="custom-select form-control"
                      formControlName="adressType"
                    >
                      <option value="Billing Address">Billing Address</option>
                      <option value="Shipment Address">Shipment Address</option>
                      <option value="Home Address">Home Address</option>
                    </select>
                  </td>
                  <td width="15%">
                    <input
                      type="text"
                      class="form-control"
                      formControlName="country"
                    />
                  </td>
                  <td width="15%">
                    <input
                      type="text"
                      class="form-control"
                      formControlName="city"
                    />
                  </td>
                  <td width="10%">
                    <input
                      type="text"
                      class="form-control"
                      formControlName="postalCode"
                    />
                  </td>
                  <td>
                    <input
                      type="text"
                      class="form-control"
                      formControlName="adress"
                    />
                  </td>
                  <td>
                    <button
                      class="btn btn-outline-primary"
                      (click)="addAdress(i, user.id)"
                    >
                      Save
                    </button>
                    <button class="btn btn-danger ml-3" (click)="user.showAddAdress = !user.showAddAdress">Cancel</button>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </td>
      </tr>
    </ng-container>
  </tbody>
</table>

